# 部屋照明最適化Q-Learningシステム（ピクセル単位版）

このプロジェクトは、Q-Learningアルゴリズムを使用して部屋の照明を最適化するシステムのピクセル単位版です。エージェントが部屋をまっすぐ進み、壁で跳ね返りながら移動し、適切な照明パターンを学習します。

## project_01からの主な変更点

### 移動システムの変更
- **旧**: 10×10のグリッド内をランダムに8方向移動
- **新**: 500×500ピクセルマップ内を連続的に移動し、壁で物理的に跳ね返る

### エージェントの動作
- **移動方式**: ランダムな角度で初期化され、まっすぐ進む
- **壁での反射**: X軸・Y軸の壁に当たると適切に角度を反転
- **移動速度**: 5ピクセル/ステップ
- **軌跡**: より自然で物理的な動きを実現

## システム概要

### 環境設定
- **マップサイズ**: 500×500ピクセル
- **照明ゾーン**: 四隅に100×100ピクセルの照明エリア（合計4箇所）
- **エージェント**: 部屋の中央から開始し、ランダムな角度で移動
- **移動速度**: 5ピクセル/ステップ
- **最大ステップ数**: 200ステップ/エピソード
- **行動空間**: 16通り（4つの照明のON/OFF組み合わせ、2^4 = 16パターン）

### 照明ゾーンの配置（ピクセル座標）
```
TL: 左上 (0,0)-(100,100)           TR: 右上 (400,0)-(500,100)
BL: 左下 (0,400)-(100,500)         BR: 右下 (400,400)-(500,500)
```

### 状態空間の工夫
- **ピクセル座標**: エージェントは500×500の連続空間を移動
- **状態の離散化**: Q-tableのサイズを管理するため、10×10グリッドに離散化
- **状態数**: 100状態（実際の移動はピクセル単位で滑らか）

## 報酬システム

### 報酬の構成要素

#### 1. 距離ベースの照明評価
- **近距離照明の点灯**: +10.0ポイント/照明
  - エージェントから距離200ピクセル以内の照明が点灯している場合
  - 快適な照明環境を提供するため高い報酬

- **近距離照明の消灯**: -15.0ポイント/照明
  - エージェントの近くで照明が消えている場合
  - 暗い環境は快適性を大幅に損なうため大きなペナルティ

- **遠距離照明の点灯**: -5.0ポイント/照明
  - エージェントから距離200ピクセル以上離れた照明が点灯している場合
  - 無駄な電力消費としてペナルティ

- **遠距離照明の消灯**: 0ポイント
  - 遠くの照明が消えているのは適切な状態

#### 2. 省エネ報酬
- **使用照明数によるペナルティ**: -1.0ポイント/照明
  - 点灯している照明の数に応じて電力消費コストを課す
  - 必要最小限の照明使用を促進

## 壁での跳ね返りの実装（重要な追加機能）

### X軸方向の反射
```python
if next_x < 0:
    next_x = -next_x
    self.velocity_x = -self.velocity_x
    self.agent_angle = math.pi - self.agent_angle
elif next_x >= self.map_size:
    next_x = 2 * self.map_size - next_x
    self.velocity_x = -self.velocity_x
    self.agent_angle = math.pi - self.agent_angle
```

### Y軸方向の反射
```python
if next_y < 0:
    next_y = -next_y
    self.velocity_y = -self.velocity_y
    self.agent_angle = -self.agent_angle
elif next_y >= self.map_size:
    next_y = 2 * self.map_size - next_y
    self.velocity_y = -self.velocity_y
    self.agent_angle = -self.agent_angle
```

### 物理的な動きの特徴
- **入射角 = 反射角**: 物理法則に従った自然な反射
- **速度保存**: 反射後も移動速度は変わらない
- **連続的な軌跡**: グリッドに縛られない滑らかな移動

## ファイル構成

- `room_lighting_optimization.py`: メインの学習・実行プログラム
- `visualize_q_learning.py`: 学習結果の可視化ツール
- `room_lighting_config.json`: 環境設定ファイル（学習後に生成）
- `room_lighting_q_table.npy`: 学習済みQ-table（学習後に生成）
- `room_lighting_training.gif`: 学習過程の動画（学習後に生成）
- `room_lighting_optimal.gif`: 最適照明パターンの動画（学習後に生成）

## 使用方法

### 1. 学習の実行（学習と動画生成）
```bash
cd project_04
python room_lighting_optimization.py
```

このコマンドで以下が実行されます：
- Q-Learningによる学習（3000エピソード）
- 学習済みQ-tableの保存（`room_lighting_q_table.npy`）
- 学習過程の動画生成（`room_lighting_training.gif`）
- 最適照明パターンの動画生成（`room_lighting_optimal.gif`）

### 2. 動画生成をスキップして学習のみ実行
学習のみを実行し、動画生成をスキップする場合：

```bash
python room_lighting_optimization.py --no-render
```

このコマンドで以下が実行されます：
- Q-Learningによる学習（3000エピソード）
- 学習済みQ-tableの保存（`room_lighting_q_table.npy`）
- 環境設定の保存（`room_lighting_config.json`）
- **動画生成をスキップ**（学習過程・最適パターンの動画は生成されない）

### 3. 動画生成のみ実行（学習をスキップ）
既存のQ-tableを使用して動画のみを生成する場合：

```bash
python room_lighting_optimization.py --render-only
```

このコマンドで以下が実行されます：
- 既存のQ-tableを読み込み（`room_lighting_q_table.npy`）
- 学習をスキップ
- 最適照明パターンの動画生成（10000フレーム、20fps）

### 4. カスタムQ-tableを使用した動画生成
別のQ-tableファイルを使用する場合：

```bash
python room_lighting_optimization.py --render-only --q-table custom_q_table.npy
```

### 5. コマンドラインオプション
```bash
# ヘルプを表示
python room_lighting_optimization.py --help

# 利用可能なオプション
--no-render     動画生成をスキップして学習のみを実行
--render-only   既存のQ-tableを読み込んで動画生成のみを実行（学習をスキップ）
--q-table       読み込むQ-tableファイルのパス（デフォルト: room_lighting_q_table.npy）
--config        読み込む設定ファイルのパス（デフォルト: room_lighting_config.json）
```

### 6. 結果の可視化
```bash
python visualize_q_learning.py
```

インタラクティブな可視化ツールで以下が可能：
- マウスを動かすと各位置での最適照明パターンを表示
- クリックすると詳細情報をコンソールに出力
- Q値ヒートマップと最適行動マップを表示

## Q-Learningパラメータ

- **学習率**: 0.1
- **割引率**: 0.95
- **初期ε値**: 1.0（完全ランダム）
- **ε減衰率**: 0.995
- **最小ε値**: 0.01
- **エピソード数**: 3000

## 学習結果の解釈

### Q値ヒートマップ
- 各グリッド位置での最大Q値を色で表現
- 高いQ値（明るい色）: その位置で良い報酬が期待できる
- 低いQ値（暗い色）: その位置では報酬が低い
- グリッド線で10×10の状態空間を表示

### 最適行動マップ
- 各位置での最適な照明パターンを表示
- エージェントの位置（青い円）に応じて適切な照明が選択される
- リアルタイムでマウス位置の照明パターンを確認可能

### 学習統計
- 平均報酬の推移で学習の進捗を確認
- 最終的なQ-tableの統計情報

## 技術的特徴

1. **連続空間での移動**: ピクセル単位の滑らかな動き
2. **物理的な反射**: 壁での自然な跳ね返り
3. **状態の離散化**: 100状態へのマッピング
4. **行動空間**: 16行動（4照明の組み合わせ）
5. **ε-greedy法**: 探索と活用のバランス
6. **動画出力**: PILを使用したGIF生成
7. **インタラクティブ可視化**: マウス操作による詳細確認

## 視覚的な改善点

### 動画出力の違い
- **エージェント表示**: 緑の円として表示
- **移動方向**: 赤い矢印で進行方向を表示
- **軌跡の滑らかさ**: ピクセル単位での連続的な移動
- **フレーム数**: より多くのフレームで詳細な動きを記録

### 可視化ツールの改善
- **ピクセル座標表示**: グリッド番号ではなくピクセル座標を表示
- **リアルタイム更新**: マウス位置に応じた照明パターンの即座の更新
- **カーソル表示**: 青い円でエージェント位置をシミュレート

## 応用可能性

このシステムは以下のような実世界の問題に応用できます：

- **スマートホーム**: 居住者の位置に応じた照明制御
- **オフィス照明**: 従業員の動線に合わせた照明最適化
- **省エネシステム**: 電力消費を最小化しながら快適性を維持
- **IoTデバイス**: センサーと連携した自動照明制御
- **ロボット制御**: 物理的な移動を伴う制御システム

## project_01との比較

| 項目 | project_01 | project_02 |
|------|-----------|-----------|
| マップサイズ | 10×10グリッド | 500×500ピクセル |
| 移動方式 | 離散的（8方向） | 連続的（任意角度） |
| 移動単位 | 1グリッド/ステップ | 5ピクセル/ステップ |
| 壁の扱い | グリッド境界 | 物理的な反射 |
| 軌跡 | ランダムウォーク | まっすぐ進んで跳ね返る |
| 状態数 | 100状態 | 100状態（離散化） |
| 視覚表現 | グリッドベース | ピクセルベース |

## 今後の拡張

- 複数エージェントの同時学習
- 障害物の追加
- より複雑な部屋レイアウト
- 深層強化学習（DQN）への発展
- 加速度の導入（より物理的な動き）
- 異なる速度パターンの学習

